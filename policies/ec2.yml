# Elastic Compute Cloud (EC2) Policies
policies:

####################################
#####    Compliance Policies   #####
####################################

- name: ec2-auto-tag-user-who-created-instance
  resource: ec2
  description: |
    Tag any new instance with the
    Creators ID and Principle ID.
  mode:
    type: cloudtrail
    events:
      - RunInstances
  filters:
    - tag:CreatorName: absent
  actions:
    - type: auto-tag-user
      tag: Resource Contact
      principal_id_tag: CreatorId

- name: ec2-organization-tag-compliance
  resource: ec2
  comment: Report on total count of non compliant instances
  filters:
    - or:
      - "tag:Name": absent
      - "tag:Managed_by": absent
      - "tag:Environment": absent
    - not:
      - "State.Name": terminated

######################################
#####    Operational Policies   ######
######################################

- name: ec2-destroy-tag-stagingORdev-after-x-days
  resource: ec2
  comment: Report dev or staging instances not terminated within 7 days
  filters:
  - type: value
    key: "tag:Name"
    op: glob
    value: 
      - "*staging*"
      - "*dev*"
  - type: instance-age
    hours: 7
  actions:
    - type: mark-for-op
      op: stop
      days: 1

- name: ec2-stop-tag-packer-after-x-days
  resource: ec2
  comment: Report to find long running packer instances
  filters:
  - type: value
    key: "tag:Name"
    op: regex
    value: "^packer*"
  - type: instance-age
    hours: 3

- name: ec2-stop-instances-with-cleanup-tag
  resource: ec2
  filters:
    - "tag:Cleanup": present
  actions:
    - stop